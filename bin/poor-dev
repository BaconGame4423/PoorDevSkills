#!/usr/bin/env bash
#
# poor-dev — AI-powered development pipeline CLI
#
# Usage:
#   poor-dev init [--force]           Setup poor-dev in current project
#   poor-dev [OPTIONS] "description"  Run pipeline
#   poor-dev                          Interactive mode
#   poor-dev --help                   Show help
#

set -euo pipefail

# --- Resolve source directory (follows symlinks from npm link) ---
SELF="$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || realpath "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")"
POOR_DEV_SOURCE="$(CDPATH="" cd "$(dirname "$SELF")/.." && pwd)"

# --- Colors ---
C_RED="\033[38;5;203m"
C_GREEN="\033[38;5;82m"
C_YELLOW="\033[38;5;214m"
C_CYAN="\033[38;5;87m"
C_PURPLE="\033[38;5;141m"
C_RESET="\033[0m"
C_BOLD="\033[1m"

# --- Version ---
VERSION="1.0.0"

# --- Find project root ---
find_project_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -f "$dir/.poor-dev/scripts/bash/pipeline-cli.sh" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

# --- Dependency checks ---
check_dependencies() {
    local missing=()

    if ! command -v tmux &>/dev/null; then
        missing+=("tmux (required)")
    fi

    if ! command -v yq &>/dev/null; then
        missing+=("yq (required) — https://github.com/mikefarah/yq#install")
    fi

    local has_runtime=false
    if command -v claude &>/dev/null; then
        has_runtime=true
    fi
    if command -v opencode &>/dev/null; then
        has_runtime=true
    fi
    if ! $has_runtime; then
        missing+=("claude or opencode (at least one runtime required)")
    fi

    if ! command -v gum &>/dev/null; then
        missing+=("gum (required) — go install github.com/charmbracelet/gum@latest")
    fi

    if [[ ${#missing[@]} -gt 0 ]]; then
        printf "\n%bMissing dependencies:%b\n" "$C_RED" "$C_RESET"
        for dep in "${missing[@]}"; do
            printf "  %b✗%b %s\n" "$C_RED" "$C_RESET" "$dep"
        done
        exit 1
    fi
}

# --- Show help ---
show_help() {
    cat <<'HELP'
Usage: poor-dev [command] [options] ["description"]

Commands:
  init [--force]    現在のディレクトリに poor-dev をセットアップ
  ask "質問"        コードベースに関する質問応答
  report [種別]     プロジェクトレポート生成
  config [args]     パイプライン設定の表示・変更
  switch            フローを直接選択して開始
  (なし)            インタラクティブモード

Options:
  --runtime <claude|opencode>   ランタイムを指定
  --model <model>               モデルを指定
  --config <path>               設定ファイルパス
  --from <step-id>              途中のステップから再開
  --feature-dir <path>          フィーチャーディレクトリ
  --no-confirm                  確認プロンプトなし
  --help, -h                    ヘルプを表示
  --version                     バージョンを表示

Steps:
  triage, specify, clarify, plan, planreview, tasks,
  tasksreview, architecturereview, implement, qualityreview, phasereview,
  concept, goals, milestones, roadmap

Config:
  poor-dev config               設定を表示
  poor-dev config show          設定を表示
  poor-dev config get <key>     値を取得
  poor-dev config set <key> <v> 値を設定
  poor-dev config reset         デフォルトにリセット

Examples:
  poor-dev init                 プロジェクトを初期化
  poor-dev                      インタラクティブモード
  poor-dev "ユーザー認証を追加"   パイプライン実行
  poor-dev --from plan          途中から再開
  poor-dev ask "アーキテクチャは？" 質問応答
  poor-dev config set triage.model haiku  設定変更
HELP
}

# --- Show version ---
show_version() {
    printf "poor-dev %s\n" "$VERSION"
}

# --- Show banner ---
show_banner() {
    printf "\n"
    printf "  %b╭────────────────────────────────────╮%b\n" "$C_PURPLE" "$C_RESET"
    printf "  %b│%b  %b◆ poor-dev pipeline CLI%b            %b│%b\n" "$C_PURPLE" "$C_RESET" "$C_BOLD" "$C_RESET" "$C_PURPLE" "$C_RESET"
    printf "  %b╰────────────────────────────────────╯%b\n" "$C_PURPLE" "$C_RESET"
    printf "\n"
}

# --- cmd_init ---
cmd_init() {
    local force=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --force) force=true; shift ;;
            *)
                printf "%bError: Unknown option: %s%b\n" "$C_RED" "$1" "$C_RESET" >&2
                printf "Usage: poor-dev init [--force]\n" >&2
                exit 1
                ;;
        esac
    done

    # Check if already initialized
    if [[ -d ".poor-dev" ]] && ! $force; then
        printf "%bError: .poor-dev/ は既に存在します。%b\n" "$C_RED" "$C_RESET" >&2
        printf "再初期化するには --force を指定してください:\n" >&2
        printf "  poor-dev init --force\n" >&2
        exit 1
    fi

    printf "\n%b◆ poor-dev init%b — プロジェクトセットアップ\n\n" "$C_BOLD" "$C_RESET"

    # --- Copy templates ---
    printf "%bテンプレートをコピー中...%b\n" "$C_CYAN" "$C_RESET"
    mkdir -p .poor-dev/templates
    cp -r "$POOR_DEV_SOURCE/.poor-dev/templates/"* .poor-dev/templates/
    printf "  %b✓%b .poor-dev/templates/\n" "$C_GREEN" "$C_RESET"

    # --- Copy scripts ---
    printf "%bスクリプトをコピー中...%b\n" "$C_CYAN" "$C_RESET"
    mkdir -p .poor-dev/scripts/bash
    cp -r "$POOR_DEV_SOURCE/.poor-dev/scripts/bash/"* .poor-dev/scripts/bash/
    printf "  %b✓%b .poor-dev/scripts/bash/\n" "$C_GREEN" "$C_RESET"

    # --- Copy pipeline config ---
    printf "%b設定ファイルをコピー中...%b\n" "$C_CYAN" "$C_RESET"
    if [[ -f ".poor-dev/pipeline-config.yaml" ]] && $force; then
        cp ".poor-dev/pipeline-config.yaml" ".poor-dev/pipeline-config.yaml.bak"
        printf "  %b○%b 既存の pipeline-config.yaml を .bak に退避\n" "$C_YELLOW" "$C_RESET"
    fi
    cp "$POOR_DEV_SOURCE/.poor-dev/pipeline-config.yaml" .poor-dev/pipeline-config.yaml
    printf "  %b✓%b .poor-dev/pipeline-config.yaml\n" "$C_GREEN" "$C_RESET"

    # --- Copy OpenCode commands (poor-dev.* only) ---
    printf "%bコマンド定義をコピー中...%b\n" "$C_CYAN" "$C_RESET"
    mkdir -p .opencode/command
    for f in "$POOR_DEV_SOURCE/.opencode/command/poor-dev."*.md; do
        [[ -f "$f" ]] && cp "$f" .opencode/command/
    done
    printf "  %b✓%b .opencode/command/poor-dev.*.md\n" "$C_GREEN" "$C_RESET"

    # --- Copy OpenCode agents ---
    mkdir -p .opencode/agents
    cp -r "$POOR_DEV_SOURCE/.opencode/agents/"*.md .opencode/agents/
    printf "  %b✓%b .opencode/agents/\n" "$C_GREEN" "$C_RESET"

    # --- Copy OpenCode package.json ---
    cp "$POOR_DEV_SOURCE/.opencode/package.json" .opencode/package.json
    printf "  %b✓%b .opencode/package.json\n" "$C_GREEN" "$C_RESET"

    # --- Copy Claude Code agents ---
    printf "%bClaude Code エージェントをコピー中...%b\n" "$C_CYAN" "$C_RESET"
    mkdir -p .claude/agents
    cp -r "$POOR_DEV_SOURCE/.claude/agents/"*.md .claude/agents/
    printf "  %b✓%b .claude/agents/\n" "$C_GREEN" "$C_RESET"

    # --- Create Claude Code command symlinks ---
    printf "%bClaude Code コマンドリンクを作成中...%b\n" "$C_CYAN" "$C_RESET"
    mkdir -p .claude/commands
    for f in .opencode/command/poor-dev.*.md; do
        [[ -f "$f" ]] || continue
        ln -sf "../../.opencode/command/$(basename "$f")" ".claude/commands/$(basename "$f")"
    done
    printf "  %b✓%b .claude/commands/ (symlinks)\n" "$C_GREEN" "$C_RESET"

    # --- Create skeleton files (only if not existing) ---
    printf "%bスケルトンファイルを作成中...%b\n" "$C_CYAN" "$C_RESET"
    mkdir -p .poor-dev/memory
    if [[ ! -f ".poor-dev/memory/constitution.md" ]]; then
        printf "# Constitution\n" > .poor-dev/memory/constitution.md
        printf "  %b✓%b .poor-dev/memory/constitution.md (new)\n" "$C_GREEN" "$C_RESET"
    else
        printf "  %b○%b .poor-dev/memory/constitution.md (existing, kept)\n" "$C_YELLOW" "$C_RESET"
    fi

    if [[ ! -f ".poor-dev/memory/bug-patterns.md" ]]; then
        printf "# Bug Patterns\n" > .poor-dev/memory/bug-patterns.md
        printf "  %b✓%b .poor-dev/memory/bug-patterns.md (new)\n" "$C_GREEN" "$C_RESET"
    else
        printf "  %b○%b .poor-dev/memory/bug-patterns.md (existing, kept)\n" "$C_YELLOW" "$C_RESET"
    fi

    mkdir -p specs
    printf "  %b✓%b specs/ (directory)\n" "$C_GREEN" "$C_RESET"

    # --- Install OpenCode plugin dependencies ---
    printf "%bOpenCode プラグイン依存をインストール中...%b\n" "$C_CYAN" "$C_RESET"
    if [[ -f ".opencode/package.json" ]]; then
        (
            cd .opencode
            if command -v bun &>/dev/null; then
                bun install --silent 2>/dev/null && printf "  %b✓%b bun install 完了\n" "$C_GREEN" "$C_RESET" || \
                    printf "  %b○%b bun install 失敗（手動で .opencode/ 内で実行してください）\n" "$C_YELLOW" "$C_RESET"
            elif command -v npm &>/dev/null; then
                npm install --silent 2>/dev/null && printf "  %b✓%b npm install 完了\n" "$C_GREEN" "$C_RESET" || \
                    printf "  %b○%b npm install 失敗（手動で .opencode/ 内で実行してください）\n" "$C_YELLOW" "$C_RESET"
            else
                printf "  %b○%b bun/npm が見つかりません。手動で .opencode/ 内で install してください\n" "$C_YELLOW" "$C_RESET"
            fi
        )
    fi

    # --- Summary ---
    printf "\n%b✓ セットアップ完了!%b\n\n" "$C_GREEN" "$C_RESET"
    printf "次のステップ:\n"
    printf "  %bpoor-dev%b                      インタラクティブモード\n" "$C_BOLD" "$C_RESET"
    printf "  %bpoor-dev \"機能説明\"%b            パイプライン実行\n" "$C_BOLD" "$C_RESET"
    printf "\n"
}

# --- cmd_simple (non-pipeline commands: ask, report) ---
cmd_simple() {
    local cmd="$1"; shift
    local args="$*"
    local PROJECT_ROOT
    if ! PROJECT_ROOT="$(find_project_root)"; then
        printf "%bError: poor-dev が初期化されていません。%b\n" "$C_RED" "$C_RESET" >&2
        exit 1
    fi

    # Read runtime from pipeline-config.yaml
    local runtime="claude"
    local config="$PROJECT_ROOT/.poor-dev/pipeline-config.yaml"
    if [[ -f "$config" ]]; then
        local val
        val="$(yq '.defaults.runtime // "claude"' "$config" 2>/dev/null)"
        [[ -n "$val" && "$val" != "null" ]] && runtime="$val"
    fi

    case "$runtime" in
        claude)
            claude -p "Use the Skill tool to invoke /poor-dev.$cmd with args '$args'"
            ;;
        opencode)
            opencode run "/poor-dev.$cmd $args"
            ;;
    esac
}

# --- cmd_config ---
cmd_config() {
    local PROJECT_ROOT
    if ! PROJECT_ROOT="$(find_project_root)"; then
        printf "%bError: poor-dev が初期化されていません。%b\n" "$C_RED" "$C_RESET" >&2
        exit 1
    fi
    if [[ $# -eq 0 ]]; then
        bash "$PROJECT_ROOT/.poor-dev/scripts/bash/pipeline-config.sh" show
    else
        bash "$PROJECT_ROOT/.poor-dev/scripts/bash/pipeline-config.sh" "$@"
    fi
}

# --- cmd_switch ---
cmd_switch() {
    local PROJECT_ROOT
    if ! PROJECT_ROOT="$(find_project_root)"; then
        printf "%bError: poor-dev が初期化されていません。%b\n" "$C_RED" "$C_RESET" >&2
        exit 1
    fi
    # gum でフロー選択
    if ! command -v gum &>/dev/null; then
        printf "%bError: gum が必要です。%b\n" "$C_RED" "$C_RESET" >&2
        exit 1
    fi
    local flow
    flow="$(bash "$PROJECT_ROOT/.poor-dev/scripts/bash/flow-selector.sh")" || exit 1

    case "$flow" in
        ask|report)
            cmd_simple "$flow" "$@"
            ;;
        feature|bugfix|roadmap)
            # 説明文を引数から取得 or gum input
            local desc="${1:-}"
            if [[ -z "$desc" ]]; then
                desc="$(gum input --placeholder "${flow}の説明を入力..." --width 50)" || exit 1
            fi
            if [[ -z "$desc" ]]; then
                printf "%bError: 説明が入力されませんでした。%b\n" "$C_RED" "$C_RESET" >&2
                exit 1
            fi
            exec bash "$PROJECT_ROOT/.poor-dev/scripts/bash/pipeline-cli.sh" \
                --description "FLOW:${flow}:${desc}"
            ;;
    esac
}

# --- cmd_interactive ---
cmd_interactive() {
    local PROJECT_ROOT
    if ! PROJECT_ROOT="$(find_project_root)"; then
        printf "%bError: poor-dev が初期化されていません。%b\n" "$C_RED" "$C_RESET" >&2
        printf "'poor-dev init' を実行してセットアップしてください。\n" >&2
        exit 1
    fi

    exec bash "$PROJECT_ROOT/.poor-dev/scripts/bash/pipeline-cli.sh" --interactive
}

# --- cmd_run ---
cmd_run() {
    local PROJECT_ROOT
    if ! PROJECT_ROOT="$(find_project_root)"; then
        printf "%bError: poor-dev が初期化されていません。%b\n" "$C_RED" "$C_RESET" >&2
        printf "'poor-dev init' を実行してセットアップしてください。\n" >&2
        exit 1
    fi

    # Parse arguments
    local DESCRIPTION=""
    local PASS_ARGS=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --runtime|--model|--config|--from|--feature-dir)
                PASS_ARGS+=("$1" "$2")
                shift 2
                ;;
            --no-confirm)
                PASS_ARGS+=("$1")
                shift
                ;;
            -*)
                printf "%bUnknown option: %s%b\n" "$C_RED" "$1" "$C_RESET" >&2
                show_help
                exit 1
                ;;
            *)
                DESCRIPTION="$1"
                shift
                ;;
        esac
    done

    # Description is required unless --from is specified
    local has_from=false
    for arg in "${PASS_ARGS[@]:-}"; do
        if [[ "$arg" == "--from" ]]; then
            has_from=true
            break
        fi
    done

    if [[ -z "$DESCRIPTION" ]] && ! $has_from; then
        printf "%bError: Feature description required.%b\n\n" "$C_RED" "$C_RESET" >&2
        show_help
        exit 1
    fi

    if [[ -z "${_POOR_DEV_BANNER_SHOWN:-}" ]]; then
        show_banner
        printf "%bChecking dependencies...%b\n" "$C_CYAN" "$C_RESET"
        check_dependencies
        printf "%b✓ All dependencies satisfied.%b\n\n" "$C_GREEN" "$C_RESET"
    fi

    if [[ -n "$DESCRIPTION" ]]; then
        printf "%bFeature:%b %s\n" "$C_BOLD" "$C_RESET" "$DESCRIPTION"
    fi
    printf "%bLaunching tmux session...%b\n\n" "$C_CYAN" "$C_RESET"

    exec bash "$PROJECT_ROOT/.poor-dev/scripts/bash/pipeline-cli.sh" --description "$DESCRIPTION" "${PASS_ARGS[@]}"
}

# --- Main routing ---
case "${1:-}" in
    init)       shift; cmd_init "$@" ;;
    ask)        shift; cmd_simple "ask" "$@" ;;
    report)     shift; cmd_simple "report" "$@" ;;
    config)     shift; cmd_config "$@" ;;
    switch)     shift; cmd_switch "$@" ;;
    --help|-h)  show_help ;;
    --version)  show_version ;;
    "")         cmd_interactive ;;
    *)          cmd_run "$@" ;;
esac
