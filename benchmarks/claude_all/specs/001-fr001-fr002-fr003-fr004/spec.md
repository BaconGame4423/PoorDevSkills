


# Feature Specification: 微分機能付きインタラクティブ関数ビジュアライザー

**Feature Branch**: `001-fr001-fr002-fr003-fr004`
**Created**: 2026-02-17
**Status**: Draft
**Input**: User description: "微分機能付きインタラクティブ数学ツール「関数ビジュアライザー」を開発してください。要件: FR-001: インタラクティブ関数グラフ表示, FR-002: 数式入力フィールド, FR-003: リアルタイムグラフ更新, FR-004: 自動ズーム/スケール, FR-005: 軸ラベルとグリッド線, FR-006: 複数関数サポート (sin,cos,tan,log,exp,sqrt,abs), FR-007: 微分（導関数）の計算と表示, FR-008: 導関数のグラフ重畳表示, FR-009: カーソル追従ツールチップ (x, f(x), f'(x)), FR-010: 接線表示, FR-011: レスポンシブデザイン, FR-012: エラーハンドリング（不正入力）, FR-013: プリセット関数ボタン"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 数式を入力してグラフを確認する (Priority: P1)

ユーザーは数式入力フィールドに数学関数（例: `x^2 + 3*x - 5`）を入力する。入力と同時にグラフがリアルタイムで描画・更新され、関数の形状を視覚的に確認できる。グラフには軸ラベルとグリッド線が表示され、関数の値域に応じて自動的にズーム・スケールが調整される。

**Why this priority**: 関数の視覚化はツールの中核機能であり、他のすべての機能の基盤となる。
**Independent Test**: 数式入力欄に任意の関数を入力し、グラフが正しく描画されることを確認する。

**Acceptance Scenarios**:
1. **Given** ツールが初期表示されている状態で、**When** ユーザーが数式入力フィールドに `x^2` と入力する、**Then** 放物線のグラフがリアルタイムで描画され、軸ラベル（x軸・y軸）とグリッド線が表示される
2. **Given** グラフが表示されている状態で、**When** ユーザーが数式を `sin(x)` に変更する、**Then** グラフが即座に正弦波に更新され、表示範囲が自動調整される
3. **Given** 数式入力フィールドがある状態で、**When** ユーザーが `exp(x)` を入力する、**Then** 指数関数のグラフが表示され、急激な値の変化に対応してスケールが自動調整される

---

### User Story 2 - プリセット関数を選択してすぐにグラフを表示する (Priority: P1)

ユーザーはプリセット関数ボタン（sin, cos, tan, log, exp, sqrt, abs）をクリックすることで、数式を手入力せずに即座に対応するグラフを表示できる。数学に不慣れなユーザーでも簡単に様々な関数の形状を探索できる。

**Why this priority**: プリセットボタンは学習・探索のハードルを下げ、ユーザーの初回体験を向上させる主要機能である。
**Independent Test**: 各プリセットボタンをクリックし、対応する関数のグラフが正しく表示されることを確認する。

**Acceptance Scenarios**:
1. **Given** ツールが初期表示されている状態で、**When** ユーザーが `sin` プリセットボタンをクリックする、**Then** 数式入力フィールドに `sin(x)` が設定され、正弦波のグラフが表示される
2. **Given** `sin(x)` のグラフが表示されている状態で、**When** ユーザーが `log` プリセットボタンをクリックする、**Then** 数式が `log(x)` に切り替わり、対数関数のグラフに更新される
3. **Given** ツールが表示されている状態で、**When** ユーザーが各プリセットボタン（sin, cos, tan, log, exp, sqrt, abs）を順に試す、**Then** すべてのボタンで対応する関数のグラフが正しく描画される

---

### User Story 3 - 導関数を計算・表示して関数の変化率を理解する (Priority: P1)

ユーザーは入力した関数の導関数（微分）を計算し、元の関数グラフに重畳表示できる。これにより、関数の変化率・増減・極値を視覚的に理解できる。導関数のグラフは元の関数と区別可能な色やスタイルで表示される。

**Why this priority**: 微分機能はこのツールの差別化要素であり、数学教育における重要な学習支援機能である。
**Independent Test**: 関数を入力し、導関数の計算結果とグラフ重畳表示が正しいことを確認する。

**Acceptance Scenarios**:
1. **Given** `x^3` のグラフが表示されている状態で、**When** ユーザーが導関数表示を有効にする、**Then** `3*x^2`（導関数）のグラフが元のグラフに重畳して異なる色で表示される
2. **Given** `sin(x)` のグラフが表示されている状態で、**When** ユーザーが導関数表示を有効にする、**Then** `cos(x)`（導関数）のグラフが重畳表示され、元の関数と視覚的に区別できる
3. **Given** 導関数が重畳表示されている状態で、**When** ユーザーが数式を変更する、**Then** 元の関数と導関数の両方のグラフがリアルタイムで更新される

---

### User Story 4 - カーソルで関数の値と接線を確認する (Priority: P2)

ユーザーがグラフ上でカーソルを移動させると、現在位置の座標値（x）、関数値（f(x)）、導関数値（f'(x)）がツールチップで表示される。また、カーソル位置での接線をグラフ上に描画でき、関数の局所的な振る舞いを直感的に理解できる。

**Why this priority**: インタラクティブな探索機能であり、ユーザーの学習体験を大幅に向上させるが、コア表示機能の後に構築すべき機能である。
**Independent Test**: グラフ上でカーソルを動かし、ツールチップ値と接線表示が正しく追従することを確認する。

**Acceptance Scenarios**:
1. **Given** `x^2` のグラフが表示されている状態で、**When** ユーザーがグラフ上の x=2 付近にカーソルを置く、**Then** ツールチップに x≈2, f(x)≈4, f'(x)≈4 が表示される
2. **Given** カーソルがグラフ上にある状態で、**When** ユーザーが接線表示を有効にする、**Then** カーソル位置での接線が直線としてグラフ上に描画される
3. **Given** 接線が表示されている状態で、**When** ユーザーがカーソルをグラフ上の別の位置に移動する、**Then** 接線がカーソル位置に追従してリアルタイムで更新される

---

### User Story 5 - 不正な数式入力時にエラーを確認する (Priority: P2)

ユーザーが構文的に不正な数式や未定義の関数を入力した場合、わかりやすいエラーメッセージが表示され、直前の有効なグラフ表示が維持される。ユーザーは何が間違っているかを理解し、修正できる。

**Why this priority**: ユーザーの入力ミスは日常的に発生するため、適切なフィードバックはユーザー体験の品質に直結する。
**Independent Test**: 各種の不正入力を試し、エラーメッセージの表示とグラフの安定性を確認する。

**Acceptance Scenarios**:
1. **Given** `x^2` のグラフが表示されている状態で、**When** ユーザーが数式を `x^^2` に変更する、**Then** 構文エラーメッセージが表示され、直前の `x^2` のグラフが維持される
2. **Given** 数式入力フィールドが空の状態で、**When** ユーザーが空のまま確定しようとする、**Then** 「数式を入力してください」等の案内メッセージが表示される
3. **Given** ツールが表示されている状態で、**When** ユーザーが未定義の関数（例: `foo(x)`）を入力する、**Then** 認識できない関数であることを示すエラーメッセージが表示される

---

### User Story 6 - 様々なデバイスでツールを快適に使用する (Priority: P3)

ユーザーはデスクトップ、タブレット、スマートフォンなどの異なる画面サイズのデバイスでツールを使用できる。レイアウトとグラフ表示が画面サイズに応じて自動調整され、すべてのデバイスで快適な操作が可能である。

**Why this priority**: レスポンシブ対応はユーザーアクセスの幅を広げるが、デスクトップでのコア機能確立後に最適化すべき機能である。
**Independent Test**: 異なる画面サイズでツールを表示し、レイアウトが適切に調整されることを確認する。

**Acceptance Scenarios**:
1. **Given** デスクトップブラウザでツールを開いている状態で、**When** ブラウザウィンドウの幅を狭める、**Then** レイアウトが画面幅に応じて再配置され、すべての要素がアクセス可能な状態で表示される
2. **Given** スマートフォンサイズの画面でツールを開いた状態で、**When** 数式入力とプリセットボタンを操作する、**Then** タッチ操作で問題なく使用でき、グラフが画面に収まって表示される

---

### Edge Cases
- 入力が `tan(x)` で漸近線（不連続点）がある場合、どのように表示されるか？ → 不連続点付近で線を分断し、垂直の漸近線を描画しない（値の急変をクリッピングで処理）
- `log(x)` で x ≤ 0 の定義域外の場合、どのように扱うか？ → 定義域内（x > 0）のみ描画し、定義域外は空白とする
- 非常に大きい・小さい値（例: `exp(100)`）の場合のスケール処理 → 自動ズームで値域に収まるよう調整し、極端な場合はクリッピングとスクロール可能な範囲で表示
- 数式が非常に長い場合の入力フィールドの処理 → 入力フィールドは水平スクロール可能とし、フィールド幅を超える入力を受け付ける
- 導関数が存在しない点（例: `abs(x)` の x=0）での接線表示 → 微分不可能な点では接線を表示せず、ツールチップの f'(x) に「未定義」と表示する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、入力された数式に基づいてインタラクティブな関数グラフをリアルタイムで描画・表示しなければならない
- **FR-002**: システムは、ユーザーが数学関数の数式を入力できるテキスト入力フィールドを提供しなければならない
- **FR-003**: システムは、数式入力の変更に応じてグラフをリアルタイムで更新しなければならない（入力から描画更新まで体感的な遅延なし）
- **FR-004**: システムは、表示される関数の値域・定義域に応じてグラフの表示範囲（ズームレベル・スケール）を自動調整しなければならない
- **FR-005**: システムは、グラフ上に軸ラベル（x軸・y軸）とグリッド線を表示しなければならない
- **FR-006**: システムは、以下の数学関数をサポートしなければならない: sin, cos, tan, log, exp, sqrt, abs。ユーザーはこれらを数式内で使用できる
- **FR-007**: システムは、入力された関数の導関数（一次微分）を自動的に計算しなければならない
- **FR-008**: システムは、計算された導関数のグラフを元の関数グラフに重畳して表示できなければならない。導関数グラフは元の関数グラフと視覚的に区別可能（異なる色・線種）であること
- **FR-009**: システムは、ユーザーがグラフ上でカーソルを移動させた際に、カーソル位置の x 座標、f(x) の値、f'(x) の値をツールチップとして表示しなければならない
- **FR-010**: システムは、ユーザーが指定したグラフ上の任意の点において接線を描画表示できなければならない
- **FR-011**: システムは、デスクトップ・タブレット・スマートフォンの各画面サイズに対応するレスポンシブレイアウトを提供しなければならない
- **FR-012**: システムは、構文的に不正な数式や未対応の関数が入力された場合にわかりやすいエラーメッセージを表示し、直前の有効なグラフ表示を維持しなければならない
- **FR-013**: システムは、サポートされている数学関数（sin, cos, tan, log, exp, sqrt, abs）のプリセットボタンを提供しなければならない。ボタンクリックで対応する数式が入力フィールドに設定され、グラフが表示される

### Key Entities

- **数式 (Expression)**: ユーザーが入力する数学関数の文字列表現。変数 `x` を含み、算術演算子（+, -, *, /, ^）とサポート関数（sin, cos, tan, log, exp, sqrt, abs）で構成される。
- **関数グラフ (Function Graph)**: 数式を座標平面上に描画した視覚的表現。色、線の太さ、表示範囲（定義域・値域）を持つ。
- **導関数 (Derivative)**: 元の数式から数学的に導出された一次微分の数式とそのグラフ表現。元の関数とは異なる視覚スタイルで表示される。
- **接線 (Tangent Line)**: グラフ上の指定された点における接線。その点での導関数の値（傾き）と座標から計算される直線。
- **ツールチップ (Tooltip)**: カーソル位置に追従して表示される情報パネル。x 座標、f(x)、f'(x) の値を含む。
- **プリセット関数 (Preset Function)**: 事前定義された数学関数のセット（sin, cos, tan, log, exp, sqrt, abs）。ワンクリックで選択可能。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは数式を入力してから 1 秒以内にグラフの描画結果を確認できる
- **SC-002**: サポートされているすべての関数（sin, cos, tan, log, exp, sqrt, abs）が正しくグラフ描画される（既知の値との誤差が 0.1% 以内）
- **SC-003**: 導関数の計算結果が数学的に正確であり、元の関数グラフと重畳して視覚的に区別可能な状態で表示される
- **SC-004**: カーソル追従ツールチップが 100ms 以内のレスポンスタイムで x, f(x), f'(x) の値を表示する
- **SC-005**: 不正な数式入力時に、エラーメッセージが表示され、直前の有効なグラフ表示が崩れない
- **SC-006**: 320px 以上の画面幅でツールのすべての機能が操作可能であり、レイアウトが崩れない
- **SC-007**: プリセットボタンのクリックから対応するグラフ表示まで 500ms 以内で完了する
- **SC-008**: 接線表示がカーソル移動に追従し、数学的に正しい傾きで描画される

---

# Specification Quality Checklist: 微分機能付きインタラクティブ関数ビジュアライザー

**Purpose**: Validate spec completeness before planning
**Created**: 2026-02-17

## Content Quality
- [x] No implementation details (languages, frameworks, APIs)
- [x] Focused on user value; written for non-technical stakeholders
- [x] All mandatory sections completed

## Requirement Completeness
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Requirements are testable and unambiguous
- [x] Success criteria are measurable and technology-agnostic
- [x] All acceptance scenarios defined
- [x] Edge cases identified; scope clearly bounded

## Feature Readiness
- [x] All functional requirements have acceptance criteria
- [x] User scenarios cover primary flows
- [x] No implementation details leak into specification

---

**Files to create/modify**:
- `specs/001-fr001-fr002-fr003-fr004/spec.md` — 仕様書（上記内容）
- `specs/001-fr001-fr002-fr003-fr004/checklists/requirements.md` — バリデーションチェックリスト

**Unresolved items**: なし（すべての要件について合理的なデフォルトを適用済み）

**Next step**: `/poor-dev.suggest`（技術選定）または `/poor-dev.plan`（実装計画）に進行可能
