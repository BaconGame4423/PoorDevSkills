#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG="$SCRIPT_DIR/benchmarks.json"
OUTPUT="$SCRIPT_DIR/reviews/COMPARISON.md"

if [[ ! -f "$CONFIG" ]]; then
  echo "ERROR: $CONFIG not found" >&2
  exit 1
fi

jval() { jq -r "$1" "$CONFIG"; }

task_name=$(jval '.task.name')
task_desc=$(jval '.task.description')
combo_count=$(jval '.combinations | length')
today=$(date +%Y-%m-%d)

# --- ディレクトリ名・表示名の配列構築 ---
dir_names=()
display_labels=()
roles=()

for i in $(seq 0 $((combo_count - 1))); do
  dir=$(jval ".combinations[$i].dir_name")
  orch=$(jval ".combinations[$i].orchestrator")
  sub=$(jval ".combinations[$i].sub_agent")
  mode=$(jval ".combinations[$i].mode // \"pipeline\"")
  orch_disp=$(jval ".models[\"$orch\"].display_name")
  sub_disp=$(jval ".models[\"$sub\"].display_name")

  dir_names+=("$dir")

  if [[ "$mode" == "baseline" ]]; then
    display_labels+=("$orch_disp (Baseline)")
    roles+=("baseline")
  elif [[ "$orch" == "$sub" ]]; then
    display_labels+=("$orch_disp")
    roles+=("solo")
  else
    display_labels+=("$orch_disp + $sub_disp")
    roles+=("orch+sub")
  fi
done

# --- テーブルヘッダー生成 ---
# 引数: 第1列のヘッダー名
make_header() {
  local first_col="$1"
  printf -- "| %s |" "$first_col"
  for d in "${dir_names[@]}"; do
    printf -- " \`%s\` |" "$d"
  done
  echo ""
  # セパレータ
  printf -- "|---|"
  for _ in "${dir_names[@]}"; do
    printf -- "---|"
  done
  echo ""
}

# 空セル行を生成（第1列の値を指定）
make_empty_row() {
  local first_col="$1"
  printf -- "| %s |" "$first_col"
  for _ in "${dir_names[@]}"; do
    printf -- " -- |"
  done
  echo ""
}

# --- 生成開始 ---
{
  cat <<HEADER
# benchLLM 比較ダッシュボード

> タスク: ${task_name}（${task_desc}）
> 最終更新: ${today}

---

## ステータス一覧

HEADER

  # ステータス一覧テーブル
  echo "| ディレクトリ | モデル構成 | 役割 | パイプライン段階 | 出力 | ステータス |"
  echo "|---|---|---|---|---|---|"
  for i in $(seq 0 $((combo_count - 1))); do
    printf -- "| \`%s\` | %s | %s | -- | -- | 未開始 |\n" \
      "${dir_names[$i]}" "${display_labels[$i]}" "${roles[$i]}"
  done

  cat <<'SECTION'

---

## スコア比較

SECTION

  # スコア比較テーブル
  printf -- "| 次元 | 重み |"
  for d in "${dir_names[@]}"; do printf -- " \`%s\` |" "$d"; done
  echo ""
  printf -- "|---|---|"
  for _ in "${dir_names[@]}"; do printf -- "---|"; done
  echo ""

  dimensions=("Process (プロセス遵守):15%" "Code Quality (コード品質):25%" "Completeness (完全性):25%" "UX/Visual:15%" "Constitution (憲章準拠):10%" "Efficiency (効率):10%")
  for dim_entry in "${dimensions[@]}"; do
    dim_name="${dim_entry%%:*}"
    dim_weight="${dim_entry##*:}"
    printf -- "| %s | %s |" "$dim_name" "$dim_weight"
    for _ in "${dir_names[@]}"; do printf -- " -- |"; done
    echo ""
  done
  printf -- "| **総合** | **100%%** |"
  for _ in "${dir_names[@]}"; do printf -- " -- |"; done
  echo ""

  echo ""
  echo '> `--` = 未レビュー（作業完了後にレビュー実施予定）'

  cat <<'SECTION'

---

## 要件充足マトリクス

SECTION

  # 要件充足マトリクス
  make_header "要件"

  req_count=$(jval '.task.requirements | length')
  for r in $(seq 0 $((req_count - 1))); do
    req_id=$(jval ".task.requirements[$r].id")
    req_name=$(jval ".task.requirements[$r].name")
    make_empty_row "$req_id $req_name"
  done
  make_empty_row "**達成率**"

  cat <<'SECTION'

---

## 効率メトリクス

SECTION

  make_header "指標"
  metrics=("壁時計時間 (秒)" "セッション数" "出力行数" "出力バイト数" "出力速度 (lines/sec)" "生成ファイル数" "入力トークン" "出力トークン" "コスト (USD)")
  for m in "${metrics[@]}"; do
    make_empty_row "$m"
  done

  cat <<'SECTION'

---

## プロセス遵守比較

SECTION

  make_header "段階"
  stage_count=$(jval '.task.process_stages | length')
  for s in $(seq 0 $((stage_count - 1))); do
    stage=$(jval ".task.process_stages[$s]")
    make_empty_row "$stage"
  done

  cat <<'SECTION'

---

## 課題サマリ (重要度別)

### Critical (C)
_(現時点で該当なし)_

### High (H)
| ID | ディレクトリ | 内容 |
|---|---|---|
| -- | -- | -- |

### Medium (M)
| ID | ディレクトリ | 内容 |
|---|---|---|
| -- | -- | -- |

### Low (L)
| ID | ディレクトリ | 内容 |
|---|---|---|
| -- | -- | -- |

---

## 強み / 弱み 比較

SECTION

  for i in $(seq 0 $((combo_count - 1))); do
    printf -- "### %s (%s %s)\n" "${dir_names[$i]}" "${display_labels[$i]}" "${roles[$i]}"
    echo "- **強み**: --"
    echo "- **弱み**: --"
    echo "- **特徴**: --"
    echo ""
  done

  cat <<'FOOTER'
---

## レビューフロー

各ディレクトリの作業完了時:
1. `./reviews/collect-metrics.sh <dir>` でメトリクス収集
2. `cp reviews/_templates/benchmark-review.yaml reviews/<dir>.review.yaml`
3. レビュー記入
4. 本ファイル (COMPARISON.md) にスコアを追記

---

_Generated by benchLLM review framework_
FOOTER

} > "$OUTPUT"

echo "Generated $OUTPUT with $combo_count combinations"
