# Feature Specification: レビュー修正の確認フロー＋パイプライン管理

**Feature Branch**: `004-review-fix-confirmation-pipeline`
**Created**: 2026-02-12
**Status**: Draft
**Input**: User description: "軽量な修正であっても修正前にユーザーに確認するように。また修正の実行もBugFixフロー同様にパイプラインで管理。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - レビュー修正前の確認プロンプト (Priority: P1)

レビューペルソナ（例: Security Specialist, Code Reviewer 等）がアーティファクト（plan.md, tasks.md 等）の問題点を報告する。現在はフィクサーエージェントが即座に修正を適用するが、ユーザーはまず「何をどう修正するか」の要約を確認し、承認または却下してから修正が実行されるようにしたい。軽微な修正（タイポ修正、フォーマット調整等）であっても確認ステップを省略しない。

**Why this priority**: 修正の自動適用はユーザーの意図しない変更を生むリスクがある。全修正に対する確認は、ユーザーがアーティファクトの品質とスコープを常にコントロールできるようにする最も重要な機能。
**Independent Test**: 任意のレビュータイプ（planreview, tasksreview 等）を実行し、ペルソナが問題を検出した際に、修正内容の要約が表示され、ユーザーの承認なしに修正が適用されないことを確認する。

**Acceptance Scenarios**:
1. **Given** レビューペルソナが1件以上の問題を検出した状態, **When** フィクサーが修正を準備した, **Then** 修正内容の要約（対象ファイル・変更箇所・変更理由）がユーザーに提示され、承認を求める
2. **Given** 修正要約がユーザーに提示された状態, **When** ユーザーが承認した, **Then** 修正が実行される
3. **Given** 修正要約がユーザーに提示された状態, **When** ユーザーが却下した, **Then** 修正は適用されず、却下された旨がログに記録され、次のレビューイテレーションまたはパイプラインの次ステップに進む
4. **Given** レビューペルソナが問題を検出しなかった状態, **When** レビューが完了した, **Then** 確認プロンプトは表示されず、パイプラインが次のステップに進む

---

### User Story 2 - 修正のパイプライン管理（BugFix フロー準拠） (Priority: P1)

レビューで検出された修正が、BugFix フローと同様にパイプラインとして管理される。修正の規模に応じて異なるパイプラインパスを通り、修正自体も品質ゲートを経る。

**Why this priority**: パイプライン管理により、修正の追跡可能性・品質保証・レジューム可能性が確保される。BugFix フローとの一貫性がワークフロー全体の予測可能性を高める。
**Independent Test**: レビューで大規模な修正が必要と判定されたケースで、修正がBugFixの LARGE パスと同等のパイプラインステップ（plan → planreview → tasks → tasksreview → implement → 品質レビュー）を経ることを確認する。

**Acceptance Scenarios**:
1. **Given** レビューペルソナが軽微な修正（SMALL）を報告した状態, **When** ユーザーが修正を承認した, **Then** 短縮パイプライン（修正計画レビュー → 実装 → 品質確認）で修正が実行される
2. **Given** レビューペルソナが大規模な修正（LARGE）を報告した状態, **When** ユーザーが修正を承認した, **Then** 完全パイプライン（計画 → 計画レビュー → タスク生成 → タスクレビュー → 実装 → アーキテクチャレビュー → 品質レビュー）で修正が実行される
3. **Given** 修正パイプラインが途中で中断された状態, **When** パイプラインを再開した, **Then** 中断地点から実行が再開される（pipeline-state による管理）

---

### User Story 3 - 修正の一括・個別選択 (Priority: P2)

複数の問題が検出された場合、ユーザーは全修正を一括承認するか、個別に承認/却下を選択できる。

**Why this priority**: 複数の修正があるとき、一部だけ適用したいケースは頻繁に発生する。ただしP1の確認フローが先に成立していることが前提。
**Independent Test**: レビューで3件以上の問題が検出されたケースで、ユーザーが2件を承認・1件を却下し、承認された2件のみが修正されることを確認する。

**Acceptance Scenarios**:
1. **Given** レビューペルソナが3件の問題を検出した状態, **When** 修正要約が提示された, **Then** ユーザーは「全承認」「全却下」「個別選択」のいずれかを選べる
2. **Given** ユーザーが個別選択モードを選んだ状態, **When** 各修正に対して承認/却下を指定した, **Then** 承認された修正のみが実行され、却下分はスキップされる

---

### User Story 4 - 修正規模の自動判定 (Priority: P2)

修正の規模（SMALL / LARGE）がレビュー結果から自動的に判定され、適切なパイプラインパスにルーティングされる。

**Why this priority**: ユーザーの手動判定負荷を減らしつつ、規模に応じた品質保証レベルを自動適用する。
**Independent Test**: 単一ファイルのフォーマット修正が SMALL と判定され短縮パイプラインに、複数ファイルにまたがる構造変更が LARGE と判定され完全パイプラインにルーティングされることを確認する。

**Acceptance Scenarios**:
1. **Given** レビューで検出された修正が単一ファイル・局所的変更のみの状態, **When** 規模判定が行われた, **Then** SMALL と判定される
2. **Given** レビューで検出された修正が複数ファイル・構造的変更を含む状態, **When** 規模判定が行われた, **Then** LARGE と判定される
3. **Given** 規模が自動判定された状態, **When** ユーザーが判定結果を確認した, **Then** ユーザーは判定を上書き（SMALL↔LARGE）できる

---

### Edge Cases
- レビューペルソナ間で矛盾する修正提案がある場合、どう優先順位をつけるか？（既存の振る舞いを踏襲し、矛盾検出はフィクサーが統合時に判断）
- 修正パイプライン中に新たなレビュー問題が検出された場合のループ上限（既存の auto-fix loop 上限を維持）
- 確認プロンプトでユーザーが長時間応答しない場合（タイムアウトは設けず、ユーザー応答を待つ）
- 非対話モード（パイプライン内のネストされたレビュー）での確認フロー（非対話モードでもパイプラインを一時停止してユーザー確認を要求する）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、全レビュータイプ（planreview, tasksreview, architecturereview, qualityreview, phasereview）においてフィクサーが修正を適用する前に、修正内容の要約をユーザーに提示しなければならない
- **FR-002**: 修正要約には、対象ファイルパス、変更箇所の説明、変更理由（どのペルソナのどの指摘に対応するか）を含めなければならない
- **FR-003**: ユーザーは提示された修正を承認または却下できなければならない
- **FR-004**: 却下された修正は適用されず、その旨が記録されなければならない
- **FR-005**: 承認された修正は、BugFix フローと同等のパイプライン構造（SMALL パス / LARGE パス）で実行されなければならない
- **FR-006**: SMALL パスは「修正計画レビュー → 実装 → 品質確認」の短縮パイプラインで構成されなければならない
- **FR-007**: LARGE パスは「計画 → 計画レビュー → タスク生成 → タスクレビュー → 実装 → アーキテクチャレビュー → 品質レビュー」の完全パイプラインで構成されなければならない
- **FR-008**: 修正パイプラインは pipeline-state によるレジュームに対応しなければならない
- **FR-009**: 複数の修正が検出された場合、ユーザーは一括承認・一括却下・個別選択のいずれかを選べなければならない
- **FR-010**: 修正の規模（SMALL / LARGE）はレビュー結果から自動判定されなければならない
- **FR-011**: 非対話モード（`## Execution Mode: Non-Interactive` ヘッダー付き）であっても、修正前のユーザー確認は必須とする。パイプラインは確認待ちで一時停止し、ユーザーの承認/却下を得てから修正を実行する
- **FR-012**: 既存のレビュー auto-fix ループの上限回数制御は維持されなければならない

### Key Entities *(include if feature involves data)*

- **修正提案（Fix Proposal）**: レビューペルソナの指摘に対するフィクサーの修正案。属性: 対象ファイル、変更内容要約、変更理由、対応するペルソナ指摘ID、規模判定（SMALL/LARGE）、承認ステータス（pending/approved/rejected）
- **修正パイプライン状態（Fix Pipeline State）**: 修正パイプラインの進行状態。属性: 現在のステップ、完了済みステップ、承認済み修正リスト、規模判定結果。既存の pipeline-state.json 構造を拡張
- **レビューイテレーション（Review Iteration）**: auto-fix ループの1回分。属性: イテレーション番号、検出問題数、承認数、却下数、残存問題数

## Assumptions Made *(mandatory)*

| ID | Category | Assumption | Basis | Impact if Wrong |
|----|----------|-----------|-------|-----------------|
| A-001 | Scope | 全5種類のレビュータイプ（planreview, tasksreview, architecturereview, qualityreview, phasereview）に確認フローを適用する | ユーザーの「軽量な修正であっても」という表現から、例外なく全レビューに適用と解釈 | 一部レビューのみ対象の場合、不要なレビューの確認ステップが煩雑になる |
| A-002 | UX | 非対話モード（パイプライン内ネスト実行）であっても確認を強制し、パイプラインを一時停止する | ユーザーの明示的な要望により、全モードで確認を必須とする | パイプラインの一時停止が頻繁に発生し、自動化の連続性が低下する可能性がある |
| A-003 | Integration | 修正規模の判定基準はBugFix フローの既存基準（SMALL: 単一ファイル・局所変更 / LARGE: 複数ファイル・構造変更）を流用する | BugFix フローとの一貫性を重視 | レビュー修正特有の判定基準が必要な場合、誤ったパスにルーティングされる |
| A-004 | UX | 修正要約の表示形式は、ファイルパス＋変更箇所の差分要約＋ペルソナ名＋指摘内容のリスト形式とする | ユーザーが承認判断に必要な情報を最小限で提供する | より詳細な差分プレビュー（diff 形式等）が必要な場合、判断に十分な情報が得られない |
| A-005 | Scope | 既存の auto-fix ループ構造（ペルソナレビュー → フィクサー修正 → 再レビュー のループ）は維持し、各イテレーションに確認ステップを挿入する | 既存ワークフローへの影響を最小化 | ループ構造自体の変更が必要な場合、大規模なリファクタリングになる |
| A-006 | Data | pipeline-state.json の既存スキーマを拡張して修正パイプライン状態を管理する | 既存のレジューム機構との統合を重視 | 別途状態管理が必要な場合、二重管理になる |

## Success Criteria *(mandatory)*

### Measurable Outcomes
- **SC-001**: 全5種類のレビュータイプにおいて、フィクサーが修正を適用する前にユーザー確認が100%実施される（対話モード時）
- **SC-002**: ユーザーが修正要約を見て承認/却下の判断を行える（要約に対象ファイル・変更理由・ペルソナ指摘が含まれる）
- **SC-003**: 承認された修正がBugFix フロー準拠のパイプライン（SMALL パスまたは LARGE パス）で実行される
- **SC-004**: 修正パイプラインが中断後にレジューム可能である
- **SC-005**: 非対話モードであっても修正前にユーザー確認が実施され、パイプラインが適切に一時停止・再開される
- **SC-006**: 複数修正の個別承認/却下が可能で、承認分のみが実行される
