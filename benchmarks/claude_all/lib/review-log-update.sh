#!/usr/bin/env bash
# shellcheck shell=bash
set -euo pipefail
# Usage: review-log-update.sh --log <path> --issues-file <path> --verdicts <string> --iteration <N>
#
# Appends an iteration block to review-log.yaml.
#
# stdout: Updated review-log.yaml path
# exit code: 0=success, 1=error

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=utils.sh
source "$SCRIPT_DIR/utils.sh"

# --- Parse arguments ---

LOG_PATH=""
ISSUES_FILE=""
VERDICTS=""
ITERATION=0
FIXED_IDS=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --log)         LOG_PATH="$2"; shift 2 ;;
    --issues-file) ISSUES_FILE="$2"; shift 2 ;;
    --verdicts)    VERDICTS="$2"; shift 2 ;;
    --iteration)   ITERATION="$2"; shift 2 ;;
    --fixed)       FIXED_IDS="$2"; shift 2 ;;
    *)             die "Unknown argument: $1" ;;
  esac
done

: "${LOG_PATH:?--log is required}"
: "${ITERATION:?--iteration is required}"

NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# --- Initialize log if needed ---

if [[ ! -f "$LOG_PATH" ]]; then
  mkdir -p "$(dirname "$LOG_PATH")"
  cat > "$LOG_PATH" <<EOF
# Review Log
# Auto-generated by review-runner.sh
created: $NOW
iterations: []
EOF
fi

# --- Build iteration block ---

{
  echo ""
  echo "- iteration: $ITERATION"
  echo "  timestamp: $NOW"
  echo "  verdicts: \"$VERDICTS\""

  # Issues
  if [[ -n "$ISSUES_FILE" && -f "$ISSUES_FILE" ]]; then
    echo "  issues:"
    while IFS='|' read -r id severity description location persona; do
      echo "    - id: $id"
      echo "      severity: $severity"
      echo "      description: \"$description\""
      echo "      location: \"$location\""
      echo "      persona: $persona"
    done < "$ISSUES_FILE"
  else
    echo "  issues: []"
  fi

  # Fixed issues from previous iteration
  if [[ -n "$FIXED_IDS" ]]; then
    echo "  fixed:"
    IFS=',' read -ra FIXED_ARRAY <<< "$FIXED_IDS"
    for fid in "${FIXED_ARRAY[@]}"; do
      fid=$(echo "$fid" | xargs)
      [[ -n "$fid" ]] && echo "    - $fid"
    done
  fi
} >> "$LOG_PATH"

echo "$LOG_PATH"
